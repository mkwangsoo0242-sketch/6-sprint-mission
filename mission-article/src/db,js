import Database from 'better-sqlite3';
import fs from 'fs';
import path from 'path';
import { fileURLToPath } from 'url';

const __filename = fileURLToPath(import.meta.url);
const __dirname = path.dirname(__filename);

// Ensure data directory exists
const dataDir = path.join(__dirname, '..', 'data');
if (!fs.existsSync(dataDir)) {
  fs.mkdirSync(dataDir, { recursive: true });
}

const dbFile = path.join(dataDir, 'app.db');
const db = new Database(dbFile);

// Enable WAL for better concurrency
db.pragma('journal_mode = WAL');

// Bootstrap schema
db.exec(`
CREATE TABLE IF NOT EXISTS articles (
  id INTEGER PRIMARY KEY AUTOINCREMENT,
  title TEXT NOT NULL,
  content TEXT NOT NULL,
  createdAt TEXT NOT NULL DEFAULT (strftime('%Y-%m-%dT%H:%M:%fZ','now')),
  updatedAt TEXT NOT NULL DEFAULT (strftime('%Y-%m-%dT%H:%M:%fZ','now'))
);

-- Indexes for search and sorting
CREATE INDEX IF NOT EXISTS idx_articles_createdAt ON articles(createdAt DESC);
CREATE INDEX IF NOT EXISTS idx_articles_title ON articles(title);
CREATE INDEX IF NOT EXISTS idx_articles_content ON articles(content);
`);

// Helpers
export const insertArticle = db.prepare(`
  INSERT INTO articles (title, content, createdAt, updatedAt)
  VALUES (@title, @content, strftime('%Y-%m-%dT%H:%M:%fZ','now'), strftime('%Y-%m-%dT%H:%M:%fZ','now'))
`);

export const getArticleById = db.prepare(`
  SELECT id, title, content, createdAt, updatedAt
  FROM articles
  WHERE id = @id
`);

export const updateArticleById = db.prepare(`
  UPDATE articles
  SET
    title = COALESCE(@title, title),
    content = COALESCE(@content, content),
    updatedAt = strftime('%Y-%m-%dT%H:%M:%fZ','now')
  WHERE id = @id
`);

export const deleteArticleById = db.prepare(`
  DELETE FROM articles WHERE id = @id
`);

export function listArticles({
  offset = 0,
  limit = 20,
  sort = 'recent',
  query = '',
}) {
  const normalizedLimit = Math.min(Math.max(parseInt(limit, 10) || 20, 1), 100);
  const normalizedOffset = Math.max(parseInt(offset, 10) || 0, 0);
  const orderBy = sort === 'recent' ? 'createdAt DESC' : 'id ASC';

  let whereClause = '';
  const params = { limit: normalizedLimit, offset: normalizedOffset };

  if (query && query.trim().length > 0) {
    whereClause = 'WHERE title LIKE @q OR content LIKE @q';
    params.q = `%${query.trim()}%`;
  }

  const listStmt = db.prepare(`
    SELECT id, title, content, createdAt
    FROM articles
    ${whereClause}
    ORDER BY ${orderBy}
    LIMIT @limit OFFSET @offset
  `);

  const countStmt = db.prepare(`
    SELECT COUNT(*) as total
    FROM articles
    ${whereClause}
  `);

  const rows = listStmt.all(params);
  const { total } = countStmt.get(params);
  return { rows, total, offset: normalizedOffset, limit: normalizedLimit };
}

export default db;
